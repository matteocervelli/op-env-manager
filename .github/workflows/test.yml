name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y bats jq kcov

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install bats-core jq
        # Note: kcov is not available on macOS, coverage will only work on Linux

    - name: Run Unit Tests
      run: bats tests/unit/

    - name: Run Integration Tests
      run: bats tests/integration/

    - name: Run Security Tests
      run: bats tests/security/

    - name: Run Performance Tests
      run: bats tests/performance/

    - name: Run All Tests with Coverage (Linux only)
      if: runner.os == 'Linux'
      run: |
        mkdir -p coverage
        kcov --exclude-pattern=/usr/share,/tmp,test_helper coverage bats tests/

    - name: Upload coverage to Codecov
      if: runner.os == 'Linux'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/bats/cobertura.xml
        flags: bats-tests
        name: bats-coverage
